# 第五章 虚拟存储器

## 5.2请求分页存储管理方式

#### 1. 内存分配策略

---

**1. 固定分配局部置换**

 	开始为每个进程分配一定数目的物理块，在**整个运行期间不再改变**。采用该策略时，如果进程在运行中**发现缺页，只能从该进程在内存中的n个页面中选出一页换出**，然后再调入一页。

​	 困难：应为每个进程分配多少个物理块难以确定。

**2. 可变分配全局置换**

​	先为系统中的每个进程分配一定数目的物理块，在程序的运行过程中，可根据情况做适当的增加或者减少。同时OS自身**保持一个空闲的物理块队列**。如果某进程发生缺页时，由系统从空闲的物理块队列中，取出一个物理块分配给该进程，并将欲调入的页装入其中。如果空闲队列已空，OS可从所有的进程拥有的物理块中选择一个调出内存。

**3. 可变分配局部置换**

​	首先为每个进程分配一定数目的物理块，如果某进程发生缺页时，只允许从该进程在内存的页面中选出一页换出，不会影响其他进程执行。如果进程在运行中**频繁发生缺页中断，则系统再为进程分配若干物理快**；如果进程在运行中缺页率特别低，则适当减少分配给该进程的物理块。

#### 2. 页面调入策略

---

需要解决的三个问题：

1）何时调入

2）从何处调入

3）调入的执行过程

---

**1. 何时调入**

两种策略：

1）预调页策略

**原理：**采用以预测为基础的预调页策略，将那些预计在不久之后便会被访问的页面，预先调入内存。主要用于进程的首次调入时，由程序员指出应该先调入哪些页。

**缺点：**很明显，不准确

2）请求调页策略

**原理：**当程序在运行中需要访问某部分程序和数据时，若发现其所在的页面不在内存，便立即提出请求，由OS将其所需要的页面调入内存。目前应用较广泛。

**优点：**由请求调页策略所确定调入的页，一定会被访问；请求调页策略比较容易实现。

**缺点：**每次仅调入一页，需花费较大的系统开销，增加了磁盘I/O的启动频率。

------------------------------------------------------------------------------------------------------------------------------------------------------

**2. 从何处调入**

在请求分页系统中的外存分为文件区和对换区。每当发生缺页时，系统应从何处将缺页调入内存，可分为：

1）系统拥有足够的对换区空间：可以全部从对换区调入所需页面，以提高调页速度。在进程运行之前将与该进程有关的文件全部从文件去拷贝到对换区

**2）系统缺少足够的对换区空间：**凡不会被修改的文件，直接从文件区调入，换出时不用换（既**不用写回外存**），再调入时仍从文件区调入。可能被修改的部分，换出时需调到对换区，换入时从对换区调入。

**3）UNIX方式：**与进程有关的文件放在文件区，故未运行的页面应从文件区调入。曾经运行但又被换出的页面被放在对换区，下次调入应从对换区调入。进程请求的共享页面可能已被其他进程调入，无需再从对换区调入。

-----------------------------------------------------------------------------------------------------------------------------------------

**3. 页面调入的过程**

 （1）每当程序所要访问的页面未在内存时，便向CPU发出一缺页中断，中断处理程序首先保护CPU环境，分析中断原因后，转入缺页中断处理程序。

（2）该程序通过查找页表，得到该页在外存上的物理块后，如果此时内存能容纳新页，则启动磁盘I/O将所缺之页调入内存，然后修改页表。

（3）如果内存已满，则需按照某种置换算法从内存中选出一页准备换出；**如果该页未被修改过，可不必写回磁盘；但如果此页已被修改，则必须将它写回磁盘**（一般为对换区），然后把所缺的页调入内存，并修改页表中的相应表项，置其存在位为“1”，并将此页表项写入快表。

（4）在缺页调入内存后，利用修改后的页表，形成所要访问的物理地址，再去访问内存数据。